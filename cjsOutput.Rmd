---
title: "cjsOutput"
output: html_document
---
```{r load and wrangle}
out<-readRDS("results/cjsMcmc.rds")
library(reshape2)
library(data.table)
library(dplyr)
library(plotHacks)
library(coda)

outArray<-as.array(out)

wrangle<-function(x,margin=c(2)){
  getSummary<-function(x){
    meanX<-mean(x)
    quantiles<-quantile(x,c(0.025,0.975))
    return(c(meanX,quantiles))
  }
  stringSplit<-function(x,split,element){
    sapply(strsplit(x,split), "[[", element)
  }
  
  result<-apply(x,MARGIN=margin,FUN=getSummary) %>%
          melt() %>%
          dcast(var~Var1) %>%
          data.table()
    
  setnames(result,c("var","mean","lower","upper"))
  result[,var:=as.character(var)]
  
  result[,parameter:=unlist(strsplit(var,"[[]"))[seq(1,nrow(result)*2-1,2)]]
  
  result[grep(",",var),
         season:=stringSplit(var,"[[]",2) %>%
                 stringSplit(",",1) %>%
                 as.numeric()]
  result[,year:=stringSplit(var,"[[]",2) %>%
                stringSplit(",",2) %>%
                as.numeric()]
  result[,river:=stringSplit(var,"[[]",2) %>%
                 stringSplit(",",3) %>%
                 as.numeric()]
  result[,stage:=stringSplit(var,"[[]",2) %>%
                 stringSplit(",",4) %>%
                 substr(1,1) %>%
                 as.numeric()]
  
  return(result)
}

results<-wrangle(outArray)
setkey(results,parameter,river,year,season)
alive<-results[parameter=="alive",list(mean,lower,upper,season,year,river,stage)]
phiBeta<-results[parameter=="phiBeta",list(mean,lower,upper,season,year,river,stage)]
pBeta<-results[parameter=="pBeta",list(mean,lower,upper,season,year,river,stage)]
setnames(pBeta,c("season","year"),c("beta","season"))
```

```{r plot p by flow}
xFlow<-seq(-1,2,0.01)
for(a in 1:2){
  tiff.par(paste0("results/p",a,".tif"),
           mfrow=c(2,2))
  for(r in 1:4){
    plot(NA,xlim=c(-1,0.2),ylim=c(0,1))
    for(s in 1:4){
      b1<-pBeta[season==s&river==r&stage==a&beta==1,mean]
      b2<-pBeta[season==s&river==r&stage==a&beta==2,mean]
      logitP<-b1+b2*xFlow
      p<-1/(1+exp(-logitP))
      points(p~xFlow,type='l',col=palette()[s])
    }
  }
  dev.off()
}

```

```{r traceplots}
traceplot(out)
```